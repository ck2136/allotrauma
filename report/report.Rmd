---
title: "Alloimmunity & Trauma"
author: "Team Pham"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
    - \usepackage{graphicx}
    - \usepackage{booktabs}
output:
  #html_document:
    #toc: true
    #fig_caption: true
    #theme: flatly
  pdf_document:
    toc: true
    fig_caption: true
    #theme: flatly
                

---

## Tables 

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r datasetup, results='asis'}
library("knitr")
library("tidyr")

rm(list=ls())
library(rio)
dfm <- import_list("../data/raw/master.xls")
# antibody development data
abd <- import("../data/raw/LS_annotated_corr_DEIDENTIFIED.csv")
# T&S data
tns <- import("../data/raw/TBICU_order_DEIDENTIFIED.csv")
# Transfusion data
transf <- import("../data/raw/TBICU_BLODD.xlsx")
# Demographic data
demodf <- import("../data/raw/DEMO_RQ_DEIDENTIFIED.csv")


library(dplyr)

# - - - - - - - - - - - - - - - - - - - - - #
#---- rename things
# - - - - - - - - - - - - - - - - - - - - - #

names(dfm) <- c("Demo","Order","Antibody","Pregnancy","TransRxn","Trans")
demname <- c("MRN","FRN","gender","race","age","event","weight","blood_type","pregnancy_status","admit_dt","discharge_dt","death_date","encounter_key")
names(demodf) <- demname
names(tns) <- c("MRN","ORD","ORD_DT","CANCEL_DT","CANCEL_R","CANCEL_P","complete_dt","STATUS")
abdmrn <- abd %>% filter(Dev == 1) %>% dplyr::select(MRN, Dev) %>%
    rename(antibody = Dev)





library("tableone")
library("knitr")
library("labelled")
library("kableExtra")
library("dplyr")

```



```{r tab1s}
# Demographic data
democ <- demodf %>%
    # select relevant variables
    select(MRN, age, gender,race, death_date, admit_dt, discharge_dt) %>%
    # if not dead set as 0
    mutate(death = ifelse(is.na(death_date), 0, 1),
           MRN = as.integer(MRN),
           admit_dt = as.POSIXct(admit_dt, format = "%m/%d/%Y %H:%M"),
           discharge_dt = as.POSIXct(discharge_dt, format="%m/%d/%Y %H:%M")) %>%
    # only those with age and discharge date
    filter(!is.na(age) & !is.na(discharge_dt))

tab1 <- democ %>%
    left_join(
              democ %>%
                  # join the plasma data
                  left_join(
                            transf %>%
                                filter(CONTENT == "RBC") 
                            ) %>%  filter(!is.na(CONTENT)) %>%
                  # make sure Transfusion done between admissions for each MRN
                  dplyr::select(CONTENT, MRN, admit_dt, discharge_dt, TIMESTAMP) %>%
                  filter(TIMESTAMP <= discharge_dt && admit_dt <= TIMESTAMP) %>% 
                  group_by(MRN) %>%
                  summarise(RBCtrans = n())
    ) %>%
mutate(RBCtrans = ifelse(is.na(RBCtrans), 0, RBCtrans)) %>%
    # plasma transfusion
    left_join(
              democ %>%
                  # join the plasma data
                  left_join(
                            transf %>%
                                filter(CONTENT == "SPEC PLASMA-MOD") 
                            ) %>%  filter(!is.na(CONTENT)) %>%
                  # make sure Transfusion done between admissions for each MRN
                  dplyr::select(CONTENT, MRN, admit_dt, discharge_dt, TIMESTAMP) %>%
                  filter(TIMESTAMP <= discharge_dt && admit_dt <= TIMESTAMP) %>% 
                  group_by(MRN) %>%
                  summarise(plasmatrans = n())
    ) %>%
mutate(plasmatrans = ifelse(is.na(plasmatrans), 0, plasmatrans)) %>%
    left_join(
              democ %>%
                  # join the plasma data
                  left_join(
                            transf %>%
                                filter(CONTENT == "CRYO-TH") 
                            ) %>%  filter(!is.na(CONTENT)) %>%
                  # make sure Transfusion done between admissions for each MRN
                  dplyr::select(CONTENT, MRN, admit_dt, discharge_dt, TIMESTAMP) %>%
                  filter(TIMESTAMP <= discharge_dt && admit_dt <= TIMESTAMP) %>% 
                  group_by(MRN) %>%
                  summarise(cryop = n())
    ) %>%
mutate(cryop = ifelse(is.na(cryop), 0, cryop)) %>%
    left_join(
              democ %>%
                  # join the plasma data
                  left_join(
                            transf %>%
                                filter(CONTENT == "PP") 
                            ) %>%  filter(!is.na(CONTENT)) %>%
                  # make sure Transfusion done between admissions for each MRN
                  dplyr::select(CONTENT, MRN, admit_dt, discharge_dt, TIMESTAMP) %>%
                  filter(TIMESTAMP <= discharge_dt && admit_dt <= TIMESTAMP) %>% 
                  group_by(MRN) %>%
                  summarise(pp = n())
    ) %>%
mutate(pp = ifelse(is.na(pp), 0, pp)) %>% 
    # add antibody development
    left_join(
              abdmrn
    ) %>% 
mutate(antibody = ifelse(is.na(antibody), 0, 1)) %>%
    # add type & screen test performed
    left_join(
              tns %>%
                  filter(!is.na(STATUS)) %>%
                  group_by(MRN) %>%
                  summarise(ntest = n())
    ) %>% 
    mutate(los = as.numeric(difftime(discharge_dt, admit_dt, units="days")),
           ntest = ifelse(is.na(ntest), 0, ntest),
           race = ifelse(race == "Black or African American", "African American", "Other"),
           antibody = ifelse(is.na(antibody), 0, antibody))  %>%
    mutate(antibody = ifelse(antibody == 1, "Anti+","Anti-")) 


antiposcount <- tab1 %>% filter(antibody == "Anti+") %>% nrow
antinegcount <- tab1 %>% filter(antibody == "Anti-") %>% nrow


    tab1 %>%
    CreateTableOne(vars = c("age","gender","race","death","los","RBCtrans","plasmatrans","cryop","pp","ntest"),
                   factorVars = c("gender","death"), strata = c("antibody"), data=.) %>%
    print(., quote = FALSE, noSpace = TRUE, printToggle = FALSE, varLabels = TRUE, nonnormal = c("los","RBCtrans","plasmatrans","cryop","pp","ntest")) %>%
    .[, 1:3] %>%
    kable(., booktabs = TRUE, format="latex", align=c("c","c","r","r") ,caption = "Demographics")  %>%
    kable_styling(latex_options = c("scale_down"))  %>%
    #gsub(pattern="Age (years) (mean (sd))", "Age (years)", x=.) %>%
    gsub(pattern=" \\& p\\\\\\\\", paste0(" \\& \\$p^a\\$ \\\\\\\\ \\& (n = ",antinegcount ,") \\& (n = ",antiposcount ,") \\& \\\\\\\\"), x=.) %>%
    gsub(pattern="n \\& (\\d){4} \\& (\\d){2} \\& (\\\\)+", "", x=.) %>%
    gsub(pattern="Gender = M \\(\\\\%\\)", "Gender \\(\\\\% male\\)", x=.) %>%
    gsub(pattern="Ethnicity = Other \\(\\\\%\\)", "Ethnicity \\(\\\\% African American\\)", x=.) %>%
    gsub(pattern="Mortality = 1", "Mortality", x=.)  %>%
    gsub(pattern="\\[H\\]", "\\[h!\\]",x=.)

```


```{r tab2antspec, results='asis'}
library('tidyr')

###--- Total number of admissions associated  with Ab
totadmabd <- abd %>% 
    select(contains("pre Y=1"),Dev,MRN) %>%
    mutate(preabd = rowSums(.[1:16])) %>% 
    filter(preabd > 0) %>%
    #filter(preabd > 0 & Dev == 0) %>%
    dplyr::select(MRN) %>% nrow

###--- Antibodies present on admission

preadmabd <- abd %>% 
    select(contains("pre Y=1")) %>%
    mutate(preabd = rowSums(.[1:16])) %>% 
    filter(preabd > 0) %>%
    #filter(preabd > 0 & Dev == 0) %>%
    gather(., antibody, value, -preabd) %>% 
    filter(value == 1) %>%
    mutate(antibody = gsub(pattern="(.+) pre Y=1","\\1", antibody)) %>%
    group_by(antibody) %>%
    summarise(Frequency = n()) 


###-- Post Admission Antibody formed

library(tidyr)
postadmabd <- abd  %>%
    # select only those that have actually developed antibody during admission
    filter(Dev == 1) %>% 
    select(contains("during")) %>%
    .[,-1] %>%
    gather(., antibody, value) %>% 
    filter(value == 1) %>%
    group_by(antibody) %>%
    summarise(Frequency = n()) %>%
    mutate(antibody = gsub(pattern="(.+) during Y=1","\\1", antibody))
    
##-

preadmabd %>%
    full_join(postadmabd, by="antibody") %>%
    mutate_all(funs(ifelse(is.na(.), 0, .))) %>%
    rename(Antibody = antibody,
            `Pre Admission` = 2,
            `Post Admission` = 3) %>%
    kable(., booktabs = TRUE, format="latex", align=c("l","c") ,caption = "Antibody Specificity") %>%
    kable_styling(position = "center") %>%
    gsub(pattern="\\[H\\]","\\[h\\]", x=.)


```

Total number of admission associated with AB is `totadmabd`.



```{r tab3, results='asis'}

expand.grid(`Number of RBC transfusion` = c('0', '1-5','6-10','11-20','>20'), antibody= c('Anti+','Anti-')) %>%
    left_join(
              tab1 %>%
                  mutate('Number of RBC transfusion' = ifelse(RBCtrans == 0, '0', 
                                                              ifelse(RBCtrans < 6 & RBCtrans > 0, '1-5', 
                                                                     ifelse(RBCtrans <11 & RBCtrans >5, '6-10', 
                                                                            ifelse(RBCtrans >10 & RBCtrans < 21, '11-20', '>20'))))) %>%
              dplyr::select(`Number of RBC transfusion`, antibody)  %>%
              group_by(`Number of RBC transfusion`, antibody, add=TRUE) %>%
              #group_by(`Number of RBC transfusion`) %>% head
              summarise(value = n())  
    ) %>% 
    mutate(value = ifelse(is.na(value), 0, value)) %>%
    spread(antibody, value) %>% 
    mutate(`% Developed Antibody During Encounter` = `Anti+`/(`Anti+`+`Anti-`) * 100) %>%
    .[match(c("0","1-5","6-10","11-20",">20"), .$`Number of RBC transfusion`), ] %>%
    #dplyr::select(`Number of RBC transfusion`, `% Developed Antibody During Encounter`) %>%
    kable(., booktabs = TRUE, format="latex", align=c("l","c"), row.names=FALSE, caption="Transfusion and Antibody Development")   %>%
    kable_styling(position = "center") %>%
    gsub(pattern="\\[H\\]","\\[h\\]", x=.)

```


## Table 4: Outcomes analysis

## Supplemental Figure 1: Antibody Frequency by Gender

## Supplemental Figure 2: Antibody Frequency by Race

